---
layout:     post
title:      "CSAPP-虚拟存储器"
categories:   "读书笔记"
date:  2015-04-20
updated:  2015-07-26
author:     "Roway"
header-img: "http://7xizd0.com1.z0.glb.clouddn.com/blog/virtual_memory.jpg"
tags: 
    - 操作系统
---

关于《深入理解计算机系统》这本书，个人认为这本书的精华是以下三章：

<!-- more -->

* 第3章 程序的机器级表示
* 第5章 优化程序性能
* 第9章 虚拟存储器

这里谈论第9章的虚拟存储器。

# 概念理解
抽象来说，虚拟存储器被组织为一个存放在磁盘上的N个连续字节单元组成的"数组"，每个字节都有一个唯一的`虚拟地址`，这个唯一的虚拟地址是作为到"数组"的索引。磁盘上"数组"的内容被缓存在主存中。

虚拟存储器是硬件异常、硬件地址翻译、主存、磁盘文件和内核软件的完美交互，它为每个进程提供了一个大的、一致的和私有的地址空间。它提供了三个重要的能力：
1. 将主存看成是一个存储在磁盘上的地址空间的高速缓存，在主存中只保留活动区域，并根据需要在磁盘和主存之间来回传送数据，通过这种方式，高效的使用主存；
2. 为每个进程提供了一致的地址空间，从而简化了存储器的管理；
3. 保护了每个进程的地址空间不被其他进程破坏。

附：存储器层次结构(memory hierarchy)中的缓存概念
>* 存储器层次结构的本质：每一层存储设备都是较低一层的缓存。
>* 比如本地磁盘作为从远程磁盘取出的文件（比如web页面）的缓存，主存作为本地磁盘的缓存，依此类推，知道最小的缓存--CPU的寄存器集合。
>* 第k+1层的存储器被划分成连续的数据对象片(chunk)，成为块(block)，每个块都有一个唯一的地址或名字。第k层存储器被划分成为较少的块的集合，块大小与k+1层的一样。任何时刻，第k层的缓存都是第k+1层块的一个子集拷贝。数据总是以块大小为传送单元(transfer unit)在第k层和第k+1层之间来会拷贝。
>* 不同层次间的块大小可以不一样。一般而言，层次结构中较低层的设备的访问时间较长，倾向于使用较大的块。寄存器和L1高级缓存之间一般使用1个字的块，L1与L2、L2与L3、L3与主存之间一般使用8-16个字的块，主存与磁盘间一般使用几百或几千字节的块。
>* 在每一层上，我们必须要做缓存的管理，即要将缓存划分成块，在不同的层之间传送块，判定是命中还是不命中，以及相应的处理，尤其是不命中情况下的块替换。
>* 基于缓存的存储器层次结构之所以大行其道，一方面原因是因为较慢的存储设备更便宜；另一方面是因为程序往往体现局部性，包括时间局部性和空间局部性。

# 原理
虚拟存储系统将虚拟存储器分割为成为`虚拟页`（Virtual Page）的大小固定的块，物理存储器被分割为`物理页`（Physical Page），两者大小相等，物理页也叫页帧（Page frame）。

任意时间，虚拟页面的集合都分为三个不相交的子集：
* **未分配的**：VM系统还未分配或创建的页，为分配的页没有任何数据和他们相关联，因此也就不占用磁盘空间；
* **缓存的**：当前缓存在物理存储器中的已分配页；
* **为缓存的**：没有缓存在物理存储器中的已分配页。

![](http://7xizd0.com1.z0.glb.clouddn.com/blog/VitualMemory-simple.jpg)

## 交换空间

一旦一个页面被分配初始化了，它就在一个由内核维护的专门的交换文件（swap file）之间换来换去。交换文件也叫**交换空间**（swap space）或者交换区域（swap area）。所以，在任何时刻，交换空间都限制着当前运行着的进程能够分配的虚拟页面的综述，也即可用虚拟内存大小等于物理内存大小加交换空间大小。

交换空间通常是一个磁盘分区，但是也可以是一个文件。对于 RAM 小于 1GB 的用户，交换空间通常是推荐的，但是对于拥有大量的物理内存的用户来说是否使用主要看个人口味了(尽管它对于休眠到硬盘支持是必须的)。
http://www.linux.com/news/software/applications/8208-all-about-linux-swap-space

# 参考
* CSAPP，第6章：存储器层次结构，第9章：虚拟存储器；
